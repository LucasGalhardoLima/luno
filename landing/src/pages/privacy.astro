---
import BaseLayout from '@/components/BaseLayout.astro';
import LanguageToggle from '@/components/LanguageToggle.astro';
import { copyPt } from '@/content/copy.pt';
import { copyEn } from '@/content/copy.en';

const locales = {
  'pt-BR': copyPt,
  'en-US': copyEn,
};
---

<BaseLayout pageTitle={copyPt.privacyPage.title} pageDescription={copyPt.privacyPage.intro}>
  <main class="mx-auto w-full max-w-4xl px-6 py-10 md:px-8">
    <header class="mb-8 flex items-center justify-between">
      <a href="/" class="focus-ring rounded-sm text-text1 underline decoration-brand500/55 underline-offset-4" data-i18n="privacyPage.back">
        Voltar para a landing
      </a>
      <LanguageToggle />
    </header>

    <article class="rounded-3xl border border-white/10 bg-bg1/60 p-7 md:p-10">
      <h1 class="font-display text-3xl text-text0 sm:text-4xl" data-i18n="privacyPage.title">
        Política de Privacidade - Waitlist Luno
      </h1>
      <p class="mt-3 text-sm text-text1" data-i18n="privacyPage.updatedAt">Atualizado em 06 de fevereiro de 2026</p>
      <p class="mt-8 leading-relaxed text-text1" data-i18n="privacyPage.intro">
        Esta página explica como tratamos os dados enviados na waitlist da landing do Luno.
      </p>

      <section class="mt-8 space-y-6">
        <div>
          <h2 class="font-display text-2xl text-text0" data-i18n="privacyPage.items.0.title">Dados coletados</h2>
          <p class="mt-2 leading-relaxed text-text1" data-i18n="privacyPage.items.0.body">Coletamos apenas o e-mail informado no formulário, além de metadados de campanha (como UTM) quando disponíveis.</p>
        </div>
        <div>
          <h2 class="font-display text-2xl text-text0" data-i18n="privacyPage.items.1.title">Finalidade</h2>
          <p class="mt-2 leading-relaxed text-text1" data-i18n="privacyPage.items.1.body">Usamos esses dados para avisar sobre acesso antecipado, novidades do produto e lançamento da versão iOS.</p>
        </div>
        <div>
          <h2 class="font-display text-2xl text-text0" data-i18n="privacyPage.items.2.title">Compartilhamento</h2>
          <p class="mt-2 leading-relaxed text-text1" data-i18n="privacyPage.items.2.body">A gestão da lista é feita por provedor externo de e-mail marketing (ConvertKit). Não vendemos seus dados.</p>
        </div>
        <div>
          <h2 class="font-display text-2xl text-text0" data-i18n="privacyPage.items.3.title">Seus direitos</h2>
          <p class="mt-2 leading-relaxed text-text1" data-i18n="privacyPage.items.3.body">Você pode solicitar remoção da lista a qualquer momento pelo link de descadastro no e-mail ou contato direto.</p>
        </div>
      </section>
    </article>
  </main>

  <script is:inline id="copy-data" type="application/json" set:html={JSON.stringify(locales)}></script>
  <script>
    type Locale = 'pt-BR' | 'en-US';
    interface CopyClient {
      [key: string]: unknown;
    }

    function parseJsonScript<T>(id: string): T {
      const node = document.getElementById(id);
      if (!(node instanceof HTMLScriptElement) || !node.textContent) {
        throw new Error(`Missing JSON script: ${id}`);
      }
      return JSON.parse(node.textContent) as T;
    }

    function inferLocale(language: string | undefined, fallback: Locale): Locale {
      if (!language) return fallback;
      const normalized = language.toLowerCase();
      if (normalized.startsWith('pt')) return 'pt-BR';
      if (normalized.startsWith('en')) return 'en-US';
      return fallback;
    }

    type UtmKey =
      | 'utm_source'
      | 'utm_medium'
      | 'utm_campaign'
      | 'utm_term'
      | 'utm_content'
      | 'gclid'
      | 'fbclid';
    type UtmMap = Partial<Record<UtmKey, string>>;

    function readUtmParams(search: URLSearchParams): UtmMap {
      const keys: UtmKey[] = [
        'utm_source',
        'utm_medium',
        'utm_campaign',
        'utm_term',
        'utm_content',
        'gclid',
        'fbclid',
      ];
      return keys.reduce<UtmMap>((acc, key) => {
        const value = search.get(key);
        if (value) acc[key] = value;
        return acc;
      }, {});
    }

    function appendUtmToUrl(href: string, utm: UtmMap): string {
      try {
        const url = new URL(href, window.location.origin);
        Object.entries(utm).forEach(([key, value]) => {
          if (value && !url.searchParams.has(key)) {
            url.searchParams.set(key, value);
          }
        });
        if (href.startsWith('http')) return url.toString();
        return `${url.pathname}${url.search}${url.hash}`;
      } catch {
        return href;
      }
    }

    function getValueByPath(object: unknown, path: string): string | undefined {
      const result = path.split('.').reduce<unknown>((acc, part) => {
        if (acc === null || acc === undefined) return undefined;
        if (Array.isArray(acc) && !Number.isNaN(Number(part))) {
          return acc[Number(part)];
        }
        if (typeof acc === 'object') {
          return (acc as Record<string, unknown>)[part];
        }
        return undefined;
      }, object);
      return typeof result === 'string' ? result : undefined;
    }

    const copyData = parseJsonScript<Record<Locale, CopyClient>>('copy-data');
    const localeKey = 'luno:landing:locale';
    const allowedLocales: Locale[] = ['pt-BR', 'en-US'];
    const utm = readUtmParams(new URLSearchParams(window.location.search));
    const toggleEl = document.getElementById('language-toggle');

    const backLink = document.querySelector<HTMLAnchorElement>('a[href="/"]');
    if (backLink) {
      backLink.setAttribute('href', appendUtmToUrl('/', utm));
    }

    if (!(toggleEl instanceof HTMLButtonElement)) {
      throw new Error('Language toggle is missing');
    }
    const toggle: HTMLButtonElement = toggleEl;

    function applyLocale(locale: Locale): void {
      const selectedLocale = allowedLocales.includes(locale) ? locale : 'pt-BR';
      const copy = copyData[selectedLocale] || copyData['pt-BR'];

      document.documentElement.lang = selectedLocale;
      localStorage.setItem(localeKey, selectedLocale);

      document.querySelectorAll<HTMLElement>('[data-i18n]').forEach((node) => {
        const key = node.dataset.i18n;
        if (!key) return;
        const value = getValueByPath(copy, key);
        if (value) node.textContent = value;
      });

      toggle.textContent = selectedLocale === 'pt-BR' ? 'PT' : 'EN';
      toggle.setAttribute(
        'aria-label',
        selectedLocale === 'pt-BR' ? 'Switch to English' : 'Mudar para português'
      );
    }

    const storedLocale = localStorage.getItem(localeKey) as Locale | null;
    const initialLocale = storedLocale || inferLocale(navigator.language, 'pt-BR');
    applyLocale(initialLocale);

    toggle.addEventListener('click', () => {
      const current = (localStorage.getItem(localeKey) as Locale | null) || 'pt-BR';
      applyLocale(current === 'pt-BR' ? 'en-US' : 'pt-BR');
    });
  </script>
</BaseLayout>
